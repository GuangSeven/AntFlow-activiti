## 快速将用户系统有的用户和角色集成到antflow

AntFlow引擎是基于activiti，抛弃了activiti自身带的用户系统（太弱了，并且用户系统往往有自己的用户，角色系统，数据同步往往会造成数据不一致，这对审批来说是致命的）。AntFlow自带的用户、角色、部分相关表都是**demo**表，用户下载下来以后，执行antflow-web模块下resources目录下的scripts文件夹下的bpmn_init_db_data.sql即可快速导致一些测试数据来做POC，然而生产环境中强烈不建议使用antflow自带的用户、角色和部门表（t_user,t_department,t_role)，而是替换为自己的用户和角色相关表。其实也非常简单，Antflow做了较高程度的抽象，使得用户不用熟悉整个工作流即可完成部分模块功能的对接。

## 1.方式一 改些UserServiceImpl和AfRoleServiceImpl使用到的相关mapper的sql

UserServiceImpl里面内容较多，此类上面有一大段注释，建议用户看一下。下面介绍一下每个方法做什么的

| 方法名                                                                  | 要改写的sql                                                   | 介绍                                                                                                                                                                                                                                                                                                                                             |
| ----------------------------------------------------------------------- | ------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| queryByNameFuzzy                                                        | org.openoa.base.mapper.UserMapper#queryByNameFuzzy            | 根据输入的名字模糊查找用户信息，只需要将id和name返回即可，<br />如果用户系统里字段名不叫id和name，可以使用xxx as id，xxx as name                                                                                                                                                                                                              |
| queryCompanyByNameFuzzy                                                 | org.openoa.base.mapper.UserMapper#queryCompanyByNameFuzzy     | 返回的是公司的id和name，暂时没用到，跳过即可                                                                                                                                                                                                                                                                                                     |
| queryUserByIds                                                          | org.openoa.base.mapper.UserMapper#queryByIds                  | 核心方法，根据id集合返回用户信息集合（只需要id和name，<br />字段名不一样as即可）                                                                                                                                                                                                                                                                 |
| getById                                                                 | org.openoa.base.mapper.UserMapper#queryByIds                  | 这个同上面一样，只不过传入的id是单个的，可以将单个id装到集合里面，<br />当然也可以不复用上面的，重新写一个sql也行                                                                                                                                                                                                                                |
| queryLeadersByEmployeeIdAndTier，<br />queryLeadersByEmployeeIdAndGrade | 自己找对应的sql                                               | 这两个方法实现的功能类似，都是实现层层审批（比如一个部分一共有5个<br />层级，则会将所有层级的负责人都找出来，层层审批流程），差别在于控制条件<br />不一样，第一个是指定向上查找的层数，比如三层负责人审批。第二个是<br />指定结束的层级。比如到第四层结束。如果不使用层层审批，则不用改<br />写这两个sql。前期用户大概率用不到，也就不用管它们了 |
| queryLeaderByEmployeeIdAndLevel                                         | getLeaderByLeventDepartment                                   | 指定层级领导审批，和上面层层审批不同，这个是指定某一个层级的负责人<br />审批流程。                                                                                                                                                                                                                                                               |
| getEmployeeDetailById                                                   | org.openoa.base.mapper.UserMapper#getEmployeeDetailById       | 这个主要用在流程通知上，返回的对应不再像上面只需要id和name，而是<br />需要更多信息。除了返回id，name外，如果流程通知是邮件通知，需要<br />返回用户的邮箱地址，如果是短信通知，则要返回用户的手机号，<br />mobileIsShow主要控制用户手机号是否显示，如果不显示则用户<br />可以不接收短信，可动态配置（如果库里有控制参数），也可以直接返回true     |
| getEmployeeDetailByIds                                                  | 自己找                                                        | 这个和getEmployeeDetailById类似，只不过是复数形式                                                                                                                                                                                                                                                                                                |
| checkEmployeeEffective                                                  | checkEmployeeEffective                                        | 校验员工是否有效，主要用于消息通知，流程发起到完成中间有一个过程<br />在这个过程中，员工可能由于离职或者其它原因变得无效，<br />流程引擎在发送消息时会调用此接口，如果无效则不执行动作。                                                                                                                                                         |
| queryEmployeeHrpbByEmployeeId                                           | org.openoa.base.mapper.UserMapper#getHrpbByEmployeeId         | 根据用户id查找到用户hrbp，如果用户所在公司没有hrbp这样角色<br />可以跳过                                                                                                                                                                                                                                                                         |
| queryEmployeeDirectLeaderById                                           | org.openoa.base.mapper.UserMapper#getDirectLeaderByEmployeeId | 根据员工id查找员工直属领导信息（id，name）主要用于直属领导审批                                                                                                                                                                                                                                                                                   |

AfRoleServiceImpl

| 方法名             | 要改写的sql                                                  | 描述                                                                                             |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| queryRoleByIds     | org.openoa.base.mapper.RoleMapper#queryRoleByIds             | 根据角色id查找角色信息，返回角色的id和name，如果字段名不同则使用as，主要用于流程模板选择角色下拉 |
| queryUserByRoleIds | org.openoa.base.service.AfRoleServiceImpl#queryUserByRoleIds | 根据角色id集合返回角色对应的审批人集合（id，name），主要用于指定角色审批                         |

## 方式2

改写sql是比较快的方法，除了改写sql，用户还可以自己实现AfUserService，AfRoleService然后将自己实现的服务加上@primary注解标识为主服务，这样就可以覆盖antflow默认实现的

> 需要说明的是这些审批规则核心都是根据传入的参数找到指定的审批人/通知人。人并不是必须要通过sql查出来，也可以是通过api接口得到，甚至写死（demo使用），antflow非常灵活。引擎只关心返回的数据格式（必须包含id和name字段）而不关心数据获取的途径。
